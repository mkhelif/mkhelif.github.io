<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Java : Utilisation de Protocol Buffers</title>
  <meta name="description" content="Voici un petit tutoriel sur l’utilisation du [nouveau format de Google : Protocol Buffers][1] en Java. Ce format se veut être le remplaçant de XML, standard ...">

  <link rel="stylesheet" href="/blog//css/main.css">
  <link rel="canonical" href="http://www.mkhelif.fr//blog//java-utilisation-de-protocol-buffers/">
  <link rel="alternate" type="application/rss+xml" title="Marwan Khelif" href="http://www.mkhelif.fr//blog//feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog//">Marwan Khelif</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/blog//about/">About</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/blog//about/index.html">About me</a>
          
        
          
          <a class="page-link" href="/blog//projects/index.html">Projects</a>
          
        
          
          <a class="page-link" href="/blog//jsassert/index.html">jsassert</a>
          
        
          
          <a class="page-link" href="/blog//spring-social-amazon/index.html">spring-social-amazon</a>
          
        
          
          <a class="page-link" href="/blog//blog/index.html">Blog</a>
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Java : Utilisation de Protocol Buffers</h1>
    <p class="post-meta">Jul 29, 2008 • mkhelif</p>
  </header>

  <article class="post-content">
    <p>Voici un petit tutoriel sur l’utilisation du <a href="http://www.mkhelif.fr/2008/07/10/google-lance-protocol-buffers.html">nouveau format de Google : Protocol Buffers</a> en Java. Ce format se veut être le remplaçant de XML, standard actuel pour le stockage et l’échange de données au format texte.<br />
<!--more--></p>

<p>Dans cet exemple nous allons créer un gestionnaire de contact. Ce billet est une traduction de la documentation de Google : <a href="http://code.google.com/apis/protocolbuffers/docs/javatutorial.html">Protocol Buffers Basics</a>.</p>

<h3 id="fichier-de-dfinition">Fichier de définition</h3>

<p>Tout d’abord le fichier de définition <em>.proto</em> permettant de définir le format des données.</p>

<pre lang="java">package fr.mkhelif.pb;

option java_package = "fr.mkhelif.pb.demo";
option java_outer_classname = "AddressBook";

message Contact {
  required string name = 1;
  required int32 id = 2;
  optional string email = 3;

  enum PhoneType {
    MOBILE = 0;
    HOME = 1;
    WORK = 2;
  }

  message PhoneNumber {
    required string number = 1;
    optional PhoneType type = 2 [default = HOME];
  }

  repeated PhoneNumber phone = 4;
}

message AddressBook {
  repeated Contact contact = 1;
}</pre>

<p>La déclaration d’un <strong>package</strong> permet comme en Java d’éviter les conflits de nom. Si vous déclarez un <strong>package</strong> (comme dans cet exemple) le package de la classe Java sera le même. Ici on surcharge le package java avec l’option <strong>java_package</strong>. On définie le nom de la classe Java grâce à l’option <strong>java_outer_classname</strong>. Si vous ne définissez pas de nom de classe le compileur utilisera le nom du fichier : <strong>adressbook.proto</strong> donnera <strong>AdressBook</strong>. Ensuite on définie un bean, appelé ici <strong>message</strong>, Personne avec des attributs <strong>name</strong>, <strong>id</strong>, <strong>email</strong> et <strong>phone</strong>. Comme dans les langages objets, un <strong>message</strong> (bean) est défini par des attributs. Ici une personne possède un nom (<strong>name</strong>), un identifiant (<strong>id</strong>), une adresse email et plusieurs numéros de téléphone (<strong>phone</strong>). Un attribut est soit un autre <strong>message</strong> soit un type simple : <em>string</em>, <em>int32</em>, <em>boolean</em>, <em>float</em> ou <em>double</em>. Vous pouvez aussi définir des énumérations permettant ainsi de limiter le nombre d’élément possibles (dans l’exemple précédent un numéro de téléphone possède un type qui ne peut être que : MOBILE, HOME ou WORK. Chaque champs doit être annoté d’un des modifieurs suivants :</p>

<ol>
  <li><em>required</em> : le champs est obligatoire. Si il n’est pas initialisé l’objet est marqué comme <em>uninitialized</em>. Lors de la sérialisation d’un objet <em>uninitialized</em> une <strong>RuntimeException</strong> est levée. Lors de la déserialisation une <strong>IOException</strong> est levée.</li>
  <li><em>optional</em> : le champs est optionnel et peut ne pas être initialisé. Un message avec un champs <em>optional</em> non initialisé utilisera une valeur par défaut : ** pour les types numériques, <em>false</em> pour les <em>boolean</em>, une chaîne vide pour les <em>string</em> et pour les messages une instance par défaut avec tous les champs avec des valeurs par défaut. Vous pouvez spécifier une valeur par défaut pour un champs : [default = *<value>*] comme pour le type de numéro de téléphone.</value></li>
  <li><em>repeated</em> : le champs peut être répétés 0 ou plusieurs fois. L’ordre des valeurs est respecté lors de la (dé)sérialisation. Un champs répété agit comme un tableau dynamique.</li>
</ol>

<p>Les marqueurs “=1″, “=2″, …permettent d’identifier le tag unique utilisé par ce champs lors de la sérialisation. Les marqueurs de 1 à 15 sont encodés sur un octet de moins que les marqueurs supérieurs à 16. Ainsi les marqueurs de 1 à 15 peuvent être utilisés par les champs souvent utilisés ou par les champs <em>repeated</em>.</p>

<h3 id="compilation-de-votre-protocolbuffers">Compilation de votre ProtocolBuffers</h3>

<p>Pour compiler le fichier <strong>.proto</strong> en classes il suffit d’utiliser <a href="http://code.google.com/p/protobuf/downloads/list" target="_blank">le compilateur de ProtocolBuffers</a> : <em>protoc</em>.</p>

<p>En exécutant la commande suivante le compilateur va générer une classe AddressBookProtos.java avec des classes internes :</p>

<p>protoc AddressBook.proto –java_out=<destination></destination></p>

<p>Dans le répertoire *<destination>* il va y avoir l&#8217;arborescense : *<destination>*/fr/mkhelif/pb/AddressBookProtos.java</destination></destination></p>

<h3 id="utilisation-des-classes">Utilisation des classes</h3>

<h5 id="cration-d8217un-objet">Création d’un objet</h5>

<p>Pour créer un object <strong>Contact</strong> il faut utiliser la classe : Contact.Builder qui permet d’instancier un objet valide.</p>

<pre lang="java">Contact.Builder contact = Contact.newBuilder ();
contact.setName ("Marwan KHELIF");
contact.setEmail ("contact@mkhelif.fr");

Contact.PhoneNumber phone = Contact.PhoneNumber.newBuilder ();
phone.setNumber ("0123456789");
phone.setType (Contact.PhoneType.HOME);

contact.addPhone (phone);
contact.build ();</pre>

<p>L’utilisation de ProtocolBuffers permet de chaîner les appels de méthodes, ainsi l’exemple précédent peut être écris :</p>

<pre lang="java">Contact.Builder contact = Contact.newBuilder ();
contact.setName ("Marwan KHELIF")
    .setEmail ("contact@mkhelif.fr")
    .addPhone (Contact.PhoneNumber.newBuilder ()
        .setNumber ("0123456789")
        .setType (Contact.PhoneType.HOME).build ())
    .build ();</pre>

<h5 id="srialisation-des-objets">Sérialisation des objets</h5>

<p>Afin de sérialiser un objet il y à deux méthodes :</p>

<ol>
  <li>Récupérer directement un tableau d’octets : <em>toByteArray ()</em>.</li>
  <li>Sérialiser directement dans un flux : <em>writeTo (OutputStream)</em>.</li>
</ol>

<p>De même pour la déserialisation :</p>

<ol>
  <li>Depuis un tableau d’octets : <em>parseFrom (byte[])</em>.</li>
  <li>Depuis un flux : <em>parseFrom (InputStream)</em>.</li>
</ol>

<h5 id="amlioration">Amélioration</h5>

<p>Par défaut le compilateur de ProtocolBuffers génère des fichiers le plus petits possible. Si dans votre applications vous avez des problèmes de performances dues aux classes générées, vous pouvez ajouter l’option :</p>

<pre lang="java">option optimize_for = SPEED;</pre>

<p>Cette option permet de compiler des fichiers plus gros mais à l’exécution le code sera optimizé pour votre ProtocolBuffer.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Ce nouveau format est très prometteur car la définition des fichiers <strong>proto</strong> est beaucoup plus orientée objet que XML. Cependant il reste encore des points à améliorer.</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Marwan Khelif</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Marwan Khelif</li>
          <li><a href="mailto:mkhelif@gmail.com">mkhelif@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mkhelif">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">mkhelif</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/mkhelif">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">mkhelif</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
